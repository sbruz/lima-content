# –®–∞–≥ 7: –ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –ø—Ä–æ–º—Ç—ã

## üéØ –¶–µ–ª—å
–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –ø—Ä–æ–º—Ç—ã –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –º—É–∑—ã–∫–∏ –ø–æ–¥ –∫–∞–∂–¥—É—é –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏—é (–æ—Ç–¥–µ–ª—å–Ω–æ –¥–ª—è –∂–µ–Ω—Å–∫–æ–π –∏ –º—É–∂—Å–∫–æ–π –≤–µ—Ä—Å–∏–π) –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Ö –≤ `affirmations_new.music`.

---

## üß© –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –¢–∞–±–ª–∏—Ü–∞ `affirmations_new`: `subcategory_id`, `coach_id`, `position`, `script`, `music`, `duration`.
- –¢–∞–±–ª–∏—Ü–∞ `coaches`: `id`, `coach`, `prompt`.
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `config.yaml`: `steps.music_prompts`, `versions`.

> **Pydantic:** —à–∞–≥ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å –¥–ª—è –æ—Ç–≤–µ—Ç–∞. –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º –¥—Ä—É–≥–∏—Ö —à–∞–≥–æ–≤ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```yaml
steps:
  music_prompts: true

versions: [Roxie, Goddard]
music_prompt_tail_sec: 5    # –Ω–∞ —Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥ –º—É–∑—ã–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ —Ä–µ—á–∏
```

- `music_prompt_tail_sec` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `5`) –¥–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–ø–∞—Å –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∑–∞–ø—Ä–æ—Å–∞ –≤ LLM: –ø—Ä–æ–º—Ç —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è —Ç–∞–∫, —á—Ç–æ–±—ã –º—É–∑—ã–∫–∞ –±—ã–ª–∞ –¥–ª–∏–Ω–Ω–µ–µ –æ–∑–≤—É—á–∫–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ö–≤–æ—Å—Ç.

---

## üöÄ –õ–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
1. –û—Ç–æ–±—Ä–∞—Ç—å —Ç—Ä–µ–Ω–µ—Ä–æ–≤ –ø–æ —Å–ø–∏—Å–∫—É `config.versions`.
2. –î–ª—è –∫–∞–∂–¥–æ–π –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ —Ç—Ä–µ–Ω–µ—Ä–∞:
   1. –ü–æ–ª—É—á–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏ `affirmations_new`, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ `position`.
   2. –ï—Å–ª–∏ –ø–æ–ª–µ `script` –Ω–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ (–¥–ª—è –ª—é–±–æ–π –ø–æ–∑–∏—Ü–∏–∏) ‚Äî –∑–∞–ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –∏ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–≤—è–∑–∫—É (–Ω–µ–ª—å–∑—è –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –º—É–∑—ã–∫—É –±–µ–∑ –≥–æ—Ç–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤).
   3. –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å payload –¥–ª—è LLM (`docs/agents/affirmations_music.md`), –≤–∫–ª—é—á–∞—é—â–∏–π:
      - —Å–≤–µ–¥–µ–Ω–∏—è –æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏, –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏, —Ç—Ä–µ–Ω–µ—Ä–µ;
      - –º–∞—Å—Å–∏–≤ –∞—Ñ—Ñ–∏—Ä–º–∞—Ü–∏–π —Å –ø–æ–ª—è–º–∏ `affirmation`, `scene`, `script`.
      –ü—Ä–∏ —Ä–∞—Å—á—ë—Ç–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å `affirmations_new.duration` –∏ –¥–æ–±–∞–≤–ª—è—Ç—å `music_prompt_tail_sec` —Å–µ–∫—É–Ω–¥ –∑–∞–ø–∞—Å–∞, —á—Ç–æ–±—ã –∏—Ç–æ–≥–æ–≤–∞—è –º—É–∑—ã–∫–∞ –±—ã–ª–∞ —á—É—Ç—å –¥–ª–∏–Ω–Ω–µ–µ –æ–∑–≤—É—á–∫–∏.
   4. –ó–∞–ø—Ä–æ—Å–∏—Ç—å —É LLM –Ω–∞–±–æ—Ä –º—É–∑—ã–∫–∞–ª—å–Ω—ã—Ö –ø—Ä–æ–º—Ç–æ–≤. –û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç:
      ```json
      {
        "items": [
          {
            "position": 1,
            "female": "airy ambient with soft piano...",
            "male": "warm neo-soul groove..."
          }
        ]
      }
      ```
   5. –°–æ–ø–æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç —Å –ø–æ–∑–∏—Ü–∏—è–º–∏ –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É:
      ```json
      {
        "female": "airy ambient with soft piano...",
        "male": "warm neo-soul groove..."
      }
      ```
      –≤ –ø–æ–ª–µ `affirmations_new.music`, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –æ—á–∏—Å—Ç–∏–≤ —Ç–µ–∫—Å—Ç –ø—Ä–æ–º—Ç–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö –∫–∞–≤—ã—á–µ–∫ –∏ –ø–µ—Ä–µ–≤–æ–¥–æ–≤ —Å—Ç—Ä–æ–∫.
   6. –ü–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –æ–±–Ω—É–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (`None`), –∑–∞—Ç–µ–º —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –Ω–æ–≤–æ–µ –≤ –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º JSON.
3. –í—Å–µ –æ—à–∏–±–∫–∏ LLM/Supabase –æ–±–æ—Ä–∞—á–∏–≤–∞—Ç—å –≤ `RetryableStepError`.

---

## üì¶ –í—ã—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –ü–æ–ª—è `music` –≤ —Ç–∞–±–ª–∏—Ü–µ `affirmations_new` –∑–∞–ø–æ–ª–Ω–µ–Ω—ã —Ç–µ–∫—Å—Ç–æ–≤—ã–º–∏ –ø—Ä–æ–º—Ç–∞–º–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª–∞.
- –í –∫–æ–Ω—Å–æ–ª–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏ —Å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é –ø–æ –∫–∞–∂–¥–æ–π –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–π —Å–≤—è–∑–∫–µ.
- –í `logs/last_run.log` —Å–æ–¥–µ—Ä–∂–∞—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω—ã–µ payload –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–µ—Ç—Ä–∞—è—Ö.

---

## üßæ –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –î–µ–π—Å—Ç–≤–∏—è |
|--------|---------|----------|
| `FatalStepError` –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö | Supabase –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω | –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø—ã |
| `RetryableStepError` –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ `music` | –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π | –ø–∞–π–ø–ª–∞–π–Ω –ø–æ–≤—Ç–æ—Ä–∏—Ç –ø–æ–ø—ã—Ç–∫—É |
| –û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Pydantic | –∏–∑–º–µ–Ω–∏–ª—Å—è —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ LLM | –æ–±–Ω–æ–≤–∏—Ç—å –ø—Ä–æ–º–ø—Ç/—Å—Ö–µ–º—É |

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ `affirmations_new` –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–ª–µ `music`.
- –í—Å–µ –ø—Ä–æ–º—Ç—ã —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—É (`female`/`male`) –∏ –ø–æ–∑–∏—Ü–∏–∏.
- –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –ª–æ–≥ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —à–∞–≥–æ–≤ –∏ –∏—Ç–æ–≥–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.
