# –®–∞–≥ 8: –°–≤–µ–¥–µ–Ω–∏–µ –º—É–∑—ã–∫–∏ —Å –æ–∑–≤—É—á–∫–æ–π

## üéØ –¶–µ–ª—å
–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ñ–æ–Ω–æ–≤—É—é –º—É–∑—ã–∫—É –≤ ElevenLabs –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–æ–º—Ç–æ–≤ –∏–∑ —à–∞–≥–∞ 7, –Ω–∞–ª–æ–∂–∏—Ç—å –µ—ë –Ω–∞ –≥–æ—Ç–æ–≤—É—é –æ–∑–≤—É—á–∫—É, –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∞—É–¥–∏–æ-—Ñ–∞–π–ª—ã.

---

## üß© –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- –¢–∞–±–ª–∏—Ü–∞ `affirmations_new`: –ø–æ–ª—è `id`, `subcategory_id`, `coach_id`, `position`, `duration`, `music`, `ready_music`.
- –ö–∞—Ç–∞–ª–æ–≥ `export/audio`: —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∑–≤—É—á–∫–∏ –∏–∑ —à–∞–≥–∞ 6 (`<cat>_<sub>_<coach>_<pos>_<w|m>_<lang>.mp3`).
- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `config.yaml`: –¥–∏–∞–ø–∞–∑–æ–Ω—ã `range.*`, —Å–ø–∏—Å–æ–∫ —è–∑—ã–∫–æ–≤, `audio_mix` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –≥—Ä–æ–º–∫–æ—Å—Ç–∏/—Ñ–µ–π–¥–æ–≤.
- –ü—Ä–æ–º—Ç—ã –∏–∑ `affirmations_new.music` (—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ –ø–æ–ª—É –∏ —è–∑—ã–∫–∞–º, –ø–æ–ª–µ `prompt`).

---

## ‚öôÔ∏è –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```yaml
steps:
  compose_music: true
threads_music: 5           # –ø–æ—Ç–æ–∫–æ–≤ –¥–ª—è —à–∞–≥–∞ compose_music

audio_mix:
  music_volume_db: -3      # –Ω–∞—Å–∫–æ–ª—å–∫–æ —É–º–µ–Ω—å—à–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å –º—É–∑—ã–∫–∏
  music_fade_in_ms: 2000   # –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å fade-in
  music_fade_out_ms: 4000  # –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å fade-out
  voice_fade_in_ms: 0      # fade-in –¥–ª—è –¥–æ—Ä–æ–∂–∫–∏ —Å –≥–æ–ª–æ—Å–æ–º
  voice_fade_out_ms: 0     # fade-out –¥–ª—è –¥–æ—Ä–æ–∂–∫–∏ —Å –≥–æ–ª–æ—Å–æ–º
music_prompt_tail_sec: 5   # –º—É–∑—ã–∫–∞ –¥–æ–ª—å—à–µ –æ–∑–≤—É—á–∫–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ–∫—É–Ω–¥
```

–î–∏–∞–ø–∞–∑–æ–Ω—ã `range.categories`, `range.subcategories`, `range.positions` –∏ —Å–ø–∏—Å–æ–∫ `languages` —Ñ–∏–ª—å—Ç—Ä—É—é—Ç –Ω–∞–±–æ—Ä –∑–∞–¥–∞—á.

---

## üöÄ –õ–æ–≥–∏–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏/–ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏/–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫–æ–≤ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞–º.
2. –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞–ø–∏—Å–∏ `affirmations_new` (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–æ–π –ø–æ –ø–æ–∑–∏—Ü–∏—è–º) –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ `(gender √ó language)` –∏ –ø–æ—Å—á–∏—Ç–∞—Ç—å –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–¥–∞—á. –ö–æ–º–±–∏–Ω—Ü–∏–∏, —É–∫–∞–∑–∞–Ω–Ω—ã–µ –≤ `ready_music`, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ —Å–ø–∏—Å–∫–∞.
3. –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏:
   1. –ù–∞–π—Ç–∏ –ø—Ä–æ–º—Ç –≤ `affirmations_new.music[gender][language].prompt`.
   2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–∑–≤—É—á–∫–∏ –∏–∑ `affirmations_new.duration[filename]` (—Ñ–æ–ª–±–µ–∫ ‚Äî –¥–ª–∏–Ω–∞ mp3) –∏ –ø—Ä–∏–±–∞–≤–∏—Ç—å —Ö–≤–æ—Å—Ç `music_prompt_tail_sec`, —á—Ç–æ–±—ã –º—É–∑—ã–∫–∞ –∏–≥—Ä–∞–ª–∞ —á—É—Ç—å –¥–æ–ª—å—à–µ —Ä–µ—á–∏.
   3. –í—ã–∑–≤–∞—Ç—å ElevenLabs Music API (`POST /v1/music`) c –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
      - `prompt`
      - `music_length_ms = duration * 1000`
      - `model_id = "music_v1"`
      - `force_instrumental = true`
   4. –ü–æ–ª—É—á–∏—Ç—å —Ñ–æ–Ω (mp3/base64), –ø—Ä–∏–≤–µ—Å—Ç–∏ –≥—Ä–æ–º–∫–æ—Å—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å fade-in/out —Å–æ–≥–ª–∞—Å–Ω–æ `audio_mix` (–¥–ª—è –º—É–∑—ã–∫–∏) –∏ `voice_fade_*` (–¥–ª—è –¥–æ—Ä–æ–∂–∫–∏ —Å –≥–æ–ª–æ—Å–æ–º).
   5. –ü–æ–¥–æ–≥–Ω–∞—Ç—å —Ñ–æ–Ω –ø–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–≥–æ–ª–æ—Å + —Ö–≤–æ—Å—Ç `music_prompt_tail_sec`), –Ω–∞–ª–æ–∂–∏—Ç—å –Ω–∞ –≥–æ–ª–æ—Å–æ–≤—É—é –¥–æ—Ä–æ–∂–∫—É; –ø–æ—Å–ª–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è —Ä–µ—á–∏ –º—É–∑—ã–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏–≥—Ä–∞—Ç—å —Ö–≤–æ—Å—Ç.
   6. –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª `<base>_final.mp3`, –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–æ–±–Ω–æ–≤–∏—Ç—å `affirmations_new.duration`) –∏ –¥–æ–±–∞–≤–∏—Ç—å —è–∑—ã–∫ –≤ `ready_music`, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å —Ç–µ –∂–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ.
4. –õ–æ–≥–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤, —É—Å–ø–µ—à–Ω—ã–µ –º–∏–∫—Å—ã, ETA.

---

## üßæ –í–æ–∑–º–æ–∂–Ω—ã–µ –æ—à–∏–±–∫–∏
| –û—à–∏–±–∫–∞ | –ü—Ä–∏—á–∏–Ω–∞ | –î–µ–π—Å—Ç–≤–∏–µ |
| --- | --- | --- |
| `Missing prompt` | –í `affirmations_new.music` –Ω–µ—Ç –∑–∞–ø—Ä–æ—à–µ–Ω–Ω–æ–≥–æ —è–∑—ã–∫–∞/–ø–æ–ª–∞ | –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —à–∞–≥ 7 –∏–ª–∏ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏—é |
| `ElevenLabs request failed` | HTTP/429/500 –æ—Ç API | –†–µ—Ç—Ä–∞–∏/—É–º–µ–Ω—å—à–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É |
| `Voice file not found` | –ù–µ—Ç mp3 –∏–∑ —à–∞–≥–∞ 6 | –ü–µ—Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–∑–≤—É—á–∫—É |
| `FFmpeg/pydub error` | –ù–µ—Ç FFmpeg –Ω–∞ –º–∞—à–∏–Ω–µ | –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å FFmpeg –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –æ–∫—Ä—É–∂–µ–Ω–∏–µ |

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- –î–ª—è –∫–∞–∂–¥–æ–π –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏ –ø–æ–ª–∞ –∏ —è–∑—ã–∫–∞ —Å–æ–∑–¥–∞–Ω —Ñ–∞–π–ª `<base>_final.mp3`.
- –ü–æ–ª–µ `affirmations_new.duration` –¥–æ–ø–æ–ª–Ω–µ–Ω–æ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é —Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤.
- –ü–æ–ª–µ `affirmations_new.ready_music` –æ–±–Ω–æ–≤–ª–µ–Ω–æ —Å–ø–∏—Å–∫–∞–º–∏ –≥–æ—Ç–æ–≤—ã—Ö —è–∑—ã–∫–æ–≤ –ø–æ –ø–æ–ª—É.
- –õ–æ–≥–∏ —Å–æ–¥–µ—Ä–∂–∞—Ç –ø–æ–ª–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å (–∑–∞–ø—Ä–æ—Å—ã, —É—Å–ø–µ—Ö–∏, –æ—à–∏–±–∫–∏, ETA).
